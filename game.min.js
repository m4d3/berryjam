function onLoadCompleted(){window.kongregate=kongregateAPI.getAPI();var n="kongregate_user_id="+kongregate.services.getUserId()+"&kongregate_game_auth_token="+kongregate.services.getGameAuthToken()}function submitScore(n){kongregate.services.isGuest()||kongregate.stats.submit("Score",n)}var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},GravityGrid,game;(function(n){"use strict";var r=function(t){function i(){t.apply(this,arguments);this.normalMode=!1;this.menuActive=!0;this.dir=0;this.canRotate=!1;this.moveTiles=!0;this.rotated=!1;this.score=0;this.scoreMulti=0;this.scoreAccum=0;this.stageRotation=0;this.newTileAmount=1;this.offsetX=400;this.offsetY=280;this.rotDir={left:0,right:1,top:2};this.numRotations=0;this.dropTweenSpeed=500;this.secondDrop=!0}return __extends(i,t),i.prototype.create=function(){this.menu=new n.MainMenu(this.game,this);this.game.add.existing(this.menu)},i.prototype.initGame=function(){this.newTileAmount=1;this.game.add.sprite(0,0,"background");this.scoreText=this.game.add.bitmapText(this.game.world.centerX-50,465,"Amatic","Score: 0",64);this.scoreAddText=this.game.add.bitmapText(350,450,"Amatic","+3",55);this.scoreAddText.alpha=0;this.newTiles=this.game.add.group();this.backgroundGrid=this.game.add.sprite(this.game.world.centerX,265,"grid");this.gridObjects=this.game.add.group();this.gridObjects.pivot.set(132,132);this.gridObjects.x=this.game.world.centerX;this.gridObjects.y=this.offsetY;this.backgroundGrid.anchor.setTo(.5,.5);this.backgroundGrid.x=this.game.world.centerX;this.backgroundGrid.y=this.offsetY;this.newTiles.x=this.game.world.centerX-130;this.newTiles.y=50;this.gridData=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]];this.game.world.bringToTop(this.newTiles);this.game.world.bringToTop(this.gridObjects);this.game.world.bringToTop(this.scoreAddText);this.leftKey=this.game.input.keyboard.addKey(Phaser.Keyboard.LEFT);this.rightKey=this.game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);this.upKey=this.game.input.keyboard.addKey(Phaser.Keyboard.UP);this.leftKey.onDown.add(function(){this.rotateGrid(this.rotDir.left)},this);this.rightKey.onDown.add(function(){this.rotateGrid(this.rotDir.right)},this);this.upKey.onDown.add(function(){this.rotateGrid(this.rotDir.up)},this);this.game.add.button(this.game.world.centerX+185,466,"buttonRight",function(){this.rotateGrid(this.rotDir.right)},this);this.game.add.button(this.game.world.centerX-310,466,"buttonLeft",function(){this.rotateGrid(this.rotDir.left)},this);this.game.add.button(this.game.world.centerX-65,532,"buttonFull",function(){this.rotateGrid(this.rotDir.up)},this);this.game.add.button(10,20,"buttonMenu",function(){this.game.world.bringToTop(this.menu);this.menuActive=!0;this.menu.showResume()},this);this.gameOver=this.game.add.sprite(0,0,"gameOver");this.gameOver.kill();this.gameOver.alpha=0;this.yeahSound=new Phaser.Sound(this.game,"yeah");this.yeahSound2=new Phaser.Sound(this.game,"yeah2");this.soundOnButton=this.game.add.button(600,20,"soundOffButton",function(){this.game.sound.mute=!1;this.soundOffButton.revive();this.soundOnButton.kill()},this);this.soundOnButton.kill();this.soundOffButton=this.game.add.button(600,20,"soundOnButton",function(){this.game.sound.mute=!0;this.soundOffButton.kill();this.soundOnButton.revive()},this)},i.prototype.startGame=function(){this.dir=0;this.stageRotation=0;this.score=0;this.scoreAccum=0;this.scoreMulti=0;this.menuActive=!1;this.game.world.sendToBack(this.menu);this.initGame();this.fillRow();this.pushToGrid();this.fillRandom();this.dropTweenType=Phaser.Easing.Bounce.Out;this.tick()},i.prototype.setLost=function(){submitScore(this.score);this.gameOver.revive();this.game.add.tween(this.gameOver).to({alpha:1},700,Phaser.Easing.Linear.None,!0);this.gameOverText=this.game.add.bitmapText(250,250,"Amatic","Your Score is: "+this.score,65);this.gameOverText.alpha=0;this.game.add.tween(this.gameOverText).to({alpha:1},700,Phaser.Easing.Linear.None,!0);this.game.add.button(this.game.world.centerX-89,370,"playButton",function(){this.game.world.bringToTop(this.menu);this.menuActive=!0;this.menu.selectMode(this.game)},this)},i.prototype.fillRow=function(){for(var n=0;n!==5;n++)this.addPrevTile(n)},i.prototype.fillRandom=function(){for(var n,t=0,i=0;i!==this.newTileAmount;i++){for(n=this.randomIntFromInterval(0,4);n===t;)n=this.randomIntFromInterval(0,4);t=n;this.addPrevTile(n)}},i.prototype.fillPrevTiles=function(){this.newTileAmount<5?this.fillRandom():this.fillRow()},i.prototype.pushToGrid=function(){this.newTiles.forEachAlive(function(n){this.dir===0&&this.gridData[0][n.xPos]===0?(this.addTile(n.xPos,0,n.color,n.lifes),this.gridData[0][n.xPos]=n.color,n.kill()):this.dir===1&&this.gridData[4-n.xPos][0]===0?(this.addTile(0,4-n.xPos,n.color,n.lifes),this.gridData[4-n.xPos][0]=n.color,n.kill()):this.dir===2&&this.gridData[4][4-n.xPos]===0?(this.addTile(4-n.xPos,4,n.color,n.lifes),this.gridData[4][4-n.xPos]=n.color,n.kill()):this.dir===3&&this.gridData[n.xPos][4]===0&&(this.addTile(4,n.xPos,n.color,n.lifes),this.gridData[n.xPos][4]=n.color,n.kill())},this)},i.prototype.addPrevTile=function(t){var r=!0,i;this.newTiles.forEachAlive(function(n){t===n.xPos&&(r=!1)},this);r&&(i=this.newTiles.getFirstDead(),i===null&&(i=new n.Tile(this.game,0,0,1),this.newTiles.add(i)),i.revive(),i.xPos=t,i.position.setTo(t*66,0),i.setColor(this.randomIntFromInterval(1,3)),i.alpha=0,Math.random()<.1?(i.color=-1,i.lifes=5):i.lifes=0,this.game.add.tween(i).to({alpha:1},300,Phaser.Easing.Back.InOut,!0))},i.prototype.addTile=function(t,i,r,u){var f=this.gridObjects.getFirstDead();f===null&&(f=new n.Tile(this.game,0,0,1),this.gridObjects.add(f));f.rotation=-this.stageRotation;f.lifes=u;f.setData(t,i);f.setColor(r)},i.prototype.rotateGrid=function(n){var t,i,r;if(this.canRotate&&!this.menuActive){this.canRotate=!1;this.rotated=!0;this.numRotations++;this.dropTweenType=Phaser.Easing.Quadratic.Out;this.dropTweenSpeed=350;this.pushToGrid();this.secondDrop=!1;this.tick();t=this.checkDirection(n);switch(this.dir){case 0:this.gridObjects.sort("yPos",Phaser.Group.SORT_DESCENDING);break;case 1:this.gridObjects.sort("xPos",Phaser.Group.SORT_DESCENDING);break;case 2:this.gridObjects.sort("yPos",Phaser.Group.SORT_ASCENDING);break;case 3:this.gridObjects.sort("xPos",Phaser.Group.SORT_ASCENDING)}i=this.game.add.tween(this.gridObjects);i.to({rotation:this.stageRotation},t,Phaser.Easing.Back.InOut);i.onComplete.addOnce(function(){this.dropTweenType=Phaser.Easing.Bounce.Out;this.dropTweenSpeed=500;this.secondDrop=!0;this.tick()},this);i.start();r=this.game.add.tween(this.backgroundGrid);r.to({rotation:this.stageRotation},t,Phaser.Easing.Back.InOut);r.start();this.gridObjects.forEach(function(n){var i=this.game.add.tween(n);i.to({rotation:-this.stageRotation},t,Phaser.Easing.Exponential.InOut);i.start();n.color===4&&(n.lifes--,n.lifes<=0?(this.gridData[n.yPos][n.xPos]=0,n.kill()):n.lifes<5&&(n.alpha-=.15))},this);this.normalMode||this.fillPrevTiles()}},i.prototype.checkDirection=function(n){var t=500;return n===this.rotDir.right?(this.dir<3?this.dir++:this.dir=0,this.stageRotation=this.gridObjects.rotation+Math.PI/2):n===this.rotDir.left?(this.dir>0?this.dir--:this.dir=3,this.stageRotation=this.gridObjects.rotation-Math.PI/2):(this.dir++,this.dir>3&&(this.dir=0),this.dir++,this.dir>3&&(this.dir=0),this.stageRotation=this.gridObjects.rotation-Math.PI,t=800),t},i.prototype.tick=function(){var n=0;this.moveTiles=!1;this.gridObjects.forEachAlive(function(t){var i,r,u;if(n++,t.color!==4){this.dropTween=this.game.add.tween(t);i=-1;switch(this.dir){case 0:for(r=t.yPos+1;r<5;r++)if(this.gridData[r][t.xPos]===0)i=r;else break;i!==-1&&(this.gridData[t.yPos][t.xPos]=0,t.yPos=i,this.gridData[t.yPos][t.xPos]=t.color,this.dropTween.to({y:i*66},this.dropTweenSpeed,this.dropTweenType));break;case 1:for(u=t.xPos+1;u<5;u++)if(this.gridData[t.yPos][u]===0)i=u;else break;i!==-1&&(this.gridData[t.yPos][t.xPos]=0,t.xPos=i,this.gridData[t.yPos][t.xPos]=t.color,this.dropTween.to({x:i*66},this.dropTweenSpeed,this.dropTweenType));break;case 2:for(r=t.yPos-1;r>-1;r--)if(this.gridData[r][t.xPos]===0)i=r;else break;i!==-1&&(this.gridData[t.yPos][t.xPos]=0,t.yPos=i,this.gridData[t.yPos][t.xPos]=t.color,this.dropTween.to({y:i*66},this.dropTweenSpeed,this.dropTweenType));break;case 3:for(u=t.xPos-1;u>-1;u--)if(this.gridData[t.yPos][u]===0)i=u;else break;i!==-1&&(this.gridData[t.yPos][t.xPos]=0,t.xPos=i,this.gridData[t.yPos][t.xPos]=t.color,this.dropTween.to({x:i*66},this.dropTweenSpeed,this.dropTweenType))}this.dropTween.start();t.color!==-1||this.moveTiles||(t.color=4)}},this);n===25?this.setLost():this.secondDrop&&this.dropTween.onComplete.addOnce(this.checkMatch,this)},i.prototype.checkMatch=function(){this.scoreAccum=0;this.gridObjects.forEachAlive(function(n){n.color!==4&&n.color!==-1&&(n.xPos<3&&this.gridData[n.yPos][n.xPos+1]===n.color&&this.gridData[n.yPos][n.xPos+2]===n.color&&n.markKill(),n.xPos>0&&n.xPos<4&&this.gridData[n.yPos][n.xPos-1]===n.color&&this.gridData[n.yPos][n.xPos+1]===n.color&&(n.markKill(),this.scoreAddText.x=n.world.x,this.scoreAddText.y=n.world.y),n.xPos>1&&this.gridData[n.yPos][n.xPos-1]===n.color&&this.gridData[n.yPos][n.xPos-2]===n.color&&n.markKill(),n.yPos<3&&this.gridData[n.yPos+1][n.xPos]===n.color&&this.gridData[n.yPos+2][n.xPos]===n.color&&n.markKill(),n.yPos>0&&n.yPos<4&&this.gridData[n.yPos-1][n.xPos]===n.color&&this.gridData[n.yPos+1][n.xPos]===n.color&&(n.markKill(),this.scoreAddText.x=n.world.x,this.scoreAddText.y=n.world.y),n.yPos>1&&this.gridData[n.yPos-1][n.xPos]===n.color&&this.gridData[n.yPos-2][n.xPos]===n.color&&n.markKill())},this);this.gridObjects.forEachAlive(function(n){n.clearData&&(this.gridData[n.yPos][n.xPos]=0,n.clearData=!1,n.color!==-1&&(n.color!==4?this.scoreAccum>=3?this.scoreAccum+=2:this.scoreAccum++:n.kill()))},this);var n=this.score/50;this.newTileAmount<5&&(this.newTileAmount=1+Math.floor(n));this.scoreAccum>2?(this.game.time.events.add(400,this.tick,this),this.setScore(),Math.random()<.5?this.yeahSound.play():this.yeahSound2.play()):(this.scoreAccum=0,this.scoreMulti=0,this.canRotate=!0)},i.prototype.setScore=function(){this.scoreAddText.alpha=1;this.scoreAddText.setText("+"+(this.scoreAccum+this.scoreMulti));var n=this.game.add.tween(this.scoreAddText).to({alpha:0,y:this.scoreAddText.y-25},750);n.start();this.score+=this.scoreAccum+this.scoreMulti;this.scoreText.setText("Score: "+this.score);this.scoreMulti+=2},i.prototype.randomIntFromInterval=function(n,t){return Math.floor(Math.random()*(t-n+1)+n)},i}(Phaser.State),t,i;n.GameState=r;t=function(t){function i(){t.call(this,700,600,Phaser.AUTO,"content",null);this.state.add("Boot",u,!1);this.state.add("Preloader",f,!1);this.state.add("GameState",n.GameState,!1);this.state.start("Boot")}return __extends(i,t),i}(Phaser.Game);n.Game=t;var u=function(n){function t(){n.apply(this,arguments)}return __extends(t,n),t.prototype.preload=function(){this.game.stage.backgroundColor="#FFFFFF";this.load.image("preloadBar","assets/interface/marmelade.png");this.load.image("loadOverlay","assets/interface/glas.png");this.load.onLoadComplete.add(function(){this.game.state.start("Preloader",!0,!1)},this);this.load.start()},t.prototype.create=function(){this.input.maxPointers=1;this.game.device.desktop;this.game.state.start("Preloader",!0,!1)},t}(Phaser.State),f=function(n){function t(){n.apply(this,arguments)}return __extends(t,n),t.prototype.preload=function(){this.add.sprite(this.game.world.centerX-80,250,"loadOverlay");this.preloadBar=this.add.sprite(this.game.world.centerX-80,250,"preloadBar");this.load.setPreloadSprite(this.preloadBar,1);this.preloadBar.scale.y*=-1;this.preloadBar.y=441;this.load.image("titleBack","assets/interface/titleBack.jpg");this.load.image("title","assets/interface/title.png");this.load.image("logo","assets/interface/logo.png");this.load.image("playButton","assets/interface/play.png");this.load.image("controlsButton","assets/interface/controls.png");this.load.image("controlScreen","assets/interface/controlScreen.jpg");this.load.image("backButton","assets/interface/back.jpg");this.load.image("resumeButton","assets/interface/resume.png");this.load.image("restartButton","assets/interface/restart.png");this.load.image("soundOnButton","assets/interface/Sound_On.png");this.load.image("soundOffButton","assets/interface/Sound_Off.png");this.load.image("buttonMenu","assets/interface/menu.jpg");this.load.image("buttonLeft","assets/interface/rotateLeft.png");this.load.image("buttonRight","assets/interface/rotateRight.png");this.load.image("buttonFull","assets/interface/rotateFull.png");this.load.image("grid","assets/grid.jpg");this.load.image("background","assets/background.jpg");this.load.image("himbeer","assets/himbeer.png");this.load.image("blaubeer","assets/blaubeer.png");this.load.image("stachelbeer","assets/stachelbeer.png");this.load.image("himbeer_l","assets/himbeer_lach.png");this.load.image("blaubeer_l","assets/blaubeer_lach.png");this.load.image("stachelbeer_l","assets/stachelbeer_lach.png");this.load.image("rotten","assets/rotten.png");this.load.image("gameOver","assets/gameOver.jpg");this.load.audio("yeah","assets/sound/yeah.mp3");this.load.audio("yeah2","assets/sound/yeah2.mp3");this.load.bitmapFont("Amatic","assets/interface/Amatic_0.png","assets/interface/Amatic.xml");this.load.onLoadComplete.add(function(){this.game.state.start("GameState",!0,!1)},this);this.load.start()},t}(Phaser.State),e=function(n){function t(t,i){n.call(this,t);this.background=t.add.sprite(0,0,"titleBack");this.background.alpha=0;this.title=t.add.sprite(0,-100,"title");this.title.alpha=0;this.logo=t.add.sprite(0,0,"logo");this.logo.anchor.setTo(.5,.5);this.logo.position.setTo(t.world.centerX,400);this.logo.scale.setTo(1.5,1.5);this.logo.alpha=0;this.backButton=t.add.button(t.world.centerX-75,535,"backButton",function(){t.add.tween(this.controlScreen).to({alpha:0},500,Phaser.Easing.Linear.None,!0);this.backButton.kill()},this);this.backButton.kill();this.playButton=t.add.button(-200,520,"playButton",function(){t.world.sendToBack(this);i.menuActive=!1;i.startGame()},this);this.resumeButton=t.add.button(70,520,"resumeButton",function(){t.world.sendToBack(this);i.menuActive=!1},this);this.resumeButton.kill();this.restartButton=t.add.button(270,520,"restartButton",function(){t.world.sendToBack(this);i.menuActive=!1;i.startGame()},this);this.restartButton.kill();this.controlsButton=t.add.button(t.world.width+200,520,"controlsButton",function(){t.add.tween(this.controlScreen).to({alpha:1},500,Phaser.Easing.Linear.None,!0);this.backButton.revive()},this);this.controlScreen=t.add.sprite(0,0,"controlScreen");this.controlScreen.alpha=0;this.controlScreen.addChild(this.backButton);var r=t.add.tween(this.background).to({alpha:1},500,Phaser.Easing.Linear.None,!0);r.onComplete.add(function(){var n=t.add.tween(this.title).to({alpha:1},500,Phaser.Easing.Linear.None,!0);t.add.tween(this.title).to({y:150},500,Phaser.Easing.Quadratic.In,!0);n.onComplete.add(function(){var n=t.add.tween(this.logo.scale).to({x:1,y:1},750,Phaser.Easing.Bounce.Out,!0);t.add.tween(this.logo).to({alpha:1},500,Phaser.Easing.Linear.None,!0);n.onComplete.add(function(){t.add.tween(this.playButton).to({x:150},500,Phaser.Easing.Quadratic.In,!0);t.add.tween(this.controlsButton).to({x:400},500,Phaser.Easing.Quadratic.In,!0)},this)},this)},this);this.add(this.background);this.add(this.title);this.add(this.logo);this.add(this.playButton);this.add(this.resumeButton);this.add(this.restartButton);this.add(this.controlsButton);this.add(this.controlScreen)}return __extends(t,n),t.prototype.showResume=function(){this.playButton.kill();this.controlsButton.x=470;this.resumeButton.revive();this.restartButton.revive()},t}(Phaser.Group);n.MainMenu=e;i=function(n){function t(t){n.call(this,t,-100,-100,"tile");this.color=0;this.clearData=!1;this.lifes=0;this.game=t;this.anchor.setTo(.5,.5);this.destroyTween=this.game.add.tween(this);this.destroyTween.onComplete.add(this.kill,this);this.destroyTween.to({alpha:0},350,Phaser.Easing.Back.InOut);t.add.existing(this)}return __extends(t,n),t.prototype.setData=function(n,t){this.xPos=n;this.yPos=t;this.alpha=1;this.scale.setTo(1,1);this.destroyTween.stop();this.reset(n*66,t*66)},t.prototype.setColor=function(n){n===1?this.loadTexture("himbeer",0):n===2?this.loadTexture("blaubeer",0):n===3?this.loadTexture("stachelbeer",0):this.loadTexture("rotten",0);this.color=n},t.prototype.markKill=function(){this.color===1?this.loadTexture("himbeer_l",0):this.color===2?this.loadTexture("blaubeer_l",0):this.color===3&&this.loadTexture("stachelbeer_l",0);this.clearData=!0;this.game.add.tween(this.scale).to({x:0,y:0},350,Phaser.Easing.Back.InOut,!0);this.destroyTween.start()},t}(Phaser.Sprite);n.Tile=i})(GravityGrid||(GravityGrid={}));kongregateAPI.loadAPI(onLoadCompleted);game=new GravityGrid.Game;